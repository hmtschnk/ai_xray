<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Uploader</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_llm.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
</head>
<body>
  <main>
    <!-- Single Panel -->
    <div class="image-panel">
      <div class="card">
        <div class="card-header text-center text-muted small fw-bold">
          File uploader
        </div>
        <div class="card-body d-flex flex-column justify-content-center align-items-center">
          <form id="upload-form" class="w-100" enctype="multipart/form-data">
            <div class="form-group mb-3">
              <label for="file">Select .jpg or .dcm file</label>
              <input type="file" name="file" id="file" class="form-control-file" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload & Process</button>
          </form>

          <div id="alert-container" class="mt-3 w-100"></div>
          <pre id="result-json" class="mt-2 w-100"></pre>
        </div>
      </div>
    </div>
  </main>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file');
    const overlay = document.getElementById('loading-overlay');
    const alertContainer = document.getElementById('alert-container');
    const resultJson = document.getElementById('result-json');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInput.files.length) return;

        overlay.style.display = "flex";
        alertContainer.innerHTML = "";
        resultJson.textContent = "";

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const res = await fetch("/uploader", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            overlay.style.display = "none";

            if (data.error) {
                alertContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            } else if (data.success) {
                alertContainer.innerHTML = `
                    <div class="alert alert-success">
                        Upload successful! <a href="${data.view_url}" target="_blank">View X-Ray</a>
                    </div>`;
                resultJson.textContent = JSON.stringify(data.result, null, 4);
                window.open(data.view_url, "_blank");
            }

        } catch (err) {
            overlay.style.display = "none";
            alertContainer.innerHTML = `<div class="alert alert-danger">Unexpected error: ${err}</div>`;
        }
    });
});
</script>
</body>
</html>
